name: Run Gradio app until ready

inputs:
  script:
    required: true
  project:
    required: true

runs:
  using: 'composite'
  steps:
    - name: Run Gradio App
      shell: bash
      run: |
        cd ${{ inputs.project }}

        python ${{ inputs.script }} 2>&1 | tee gradio_log.txt &

        # Assign process ID
        python ${{ inputs.script }} > >(tee -a gradio_log.txt) 2>&1 &
        app_pid=$!

        set +o pipefail
        # Wait for the specific log message
        tail -n +1 -f gradio_log.txt | grep -m1 -q "Demo is ready!"

        # Capture the readiness status
        status=$?

        # Stop the Gradio app process
        echo "Stopping the Gradio app..."
        pkill -P $app_pid || echo "No child processes to kill."
        kill $app_pid || echo "App process already terminated."
        wait $app_pid || echo "App process cleanup complete."

        # Exit with the readiness check status
        exit $status
